## 🧠 Learning System - Полное руководство

## 🎯 Что это?

**Система обучения** которая автоматически улучшается на основе успехов и неудач.

```
Человек учится → Система тоже учится!
```

---

## 🔄 Как работает (простыми словами)

### Шаг 1: Запись результатов

```
Каждый раз когда система ищет кнопку:
✅ Нашла → Сохраняет скриншот + координаты
❌ Не нашла → Сохраняет скриншот области где искала
```

### Шаг 2: Накопление данных

```
После 100 попыток:
- 85 успехов ✅
- 15 неудач ❌

Система думает:
"Хм, в 15% случаев я ошибаюсь.
Давай посмотрю что изменилось."
```

### Шаг 3: Автоматическое переобучение

```
Каждые 100 примеров:
1. Анализирует неудачи
2. Создает улучшенный шаблон
3. Сохраняет новую модель
4. Становится точнее!
```

---

## 📊 Архитектура

```
┌─────────────────────────────────────────────────────────┐
│  macro_sequence.py                                      │
│  ┌──────────────────────────────────────────────────┐   │
│  │ _find_template_old()                             │   │
│  │                                                  │   │
│  │  Нашел кнопку? ✅                                │   │
│  │  → learning_system.record_success()              │   │
│  │    - Сохраняет скриншот                          │   │
│  │    - Сохраняет координаты                        │   │
│  │                                                  │   │
│  │  Не нашел? ❌                                    │   │
│  │  → learning_system.record_failure()              │   │
│  │    - Берет последнюю успешную позицию            │   │
│  │    - Делает скриншот этой области                │   │
│  │    - Сохраняет как негативный пример             │   │
│  └──────────────────────────────────────────────────┘   │
│                           ↓                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │ LearningSystem                                   │   │
│  │                                                  │   │
│  │  Каждые 100 примеров:                            │   │
│  │  → retrain()                                     │   │
│  │    1. Загружает примеры                          │   │
│  │    2. Анализирует неудачи                        │   │
│  │    3. Создает улучшенный шаблон                  │   │
│  │    4. Сохраняет модель                           │   │
│  └──────────────────────────────────────────────────┘   │
│                           ↓                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │ ExecutionDatabase (SQLite)                       │   │
│  │                                                  │   │
│  │  Таблица: executions                             │   │
│  │  - template_id                                   │   │
│  │  - success (True/False)                          │   │
│  │  - screenshot (BLOB)                             │   │
│  │  - region (x, y, w, h)                           │   │
│  │  - timestamp                                     │   │
│  │                                                  │   │
│  │  Таблица: templates                              │   │
│  │  - total_attempts                                │   │
│  │  - successful_attempts                           │   │
│  │  - failed_attempts                               │   │
│  │  - accuracy                                      │   │
│  │  - last_retrain_timestamp                        │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## 🚀 Использование

### Автоматически (включено по умолчанию)

```bash
# Просто запусти макрос
python3 main.py
→ 2. DSL Сборник
→ 11. tiktok_dom_test
→ y

# Learning System работает автоматически!
# Каждый клик записывается
# Каждые 100 примеров → переобучение
```

### Просмотр статистики

```bash
python3 utils/learning_stats.py
```

**Вывод:**
```
============================================================
📊 СТАТИСТИКА ОБУЧЕНИЯ
============================================================

📋 Найдено шаблонов: 2

🎯 templates/tiktok-like.png
   Всего попыток: 150
   ✅ Успешных: 135
   ❌ Неудачных: 15
   📈 Точность: 90.0%
   🕐 Последний успех: 2025-11-08 17:30:00
   🔄 Последнее переобучение: 2025-11-08 17:25:00

🎯 Chrome-tiktok-like-dom
   Всего попыток: 200
   ✅ Успешных: 195
   ❌ Неудачных: 5
   📈 Точность: 97.5%
   🕐 Последний успех: 2025-11-08 17:31:00
   🔄 Последнее переобучение: 2025-11-08 17:20:00

============================================================

💡 Команды:
  1. Показать примеры для шаблона
  2. Переобучить шаблон вручную
  3. Выход
```

### Визуализация прогресса

```bash
python3 utils/visualize_learning.py
```

**Графики:**
1. **Точность во времени** - как система улучшается
2. **Распределение успехов/неудач** - по всем шаблонам

---

## 💡 Практический пример

### Сценарий: TikTok изменил дизайн кнопки

#### День 1: Всё работает
```
Попытка 1-50: Находит красную кнопку ❤️ ✅
Точность: 100%
```

#### День 2: TikTok обновился
```
Попытка 51: Не находит ❌
  → Система: "Хм, не нашел. Где искал?"
  → Берет последнюю успешную позицию (450, 320)
  → Делает скриншот этой области
  → Видит: Теперь кнопка синяя 💙
  → Сохраняет как негативный пример

Попытка 52-100: Продолжает не находить ❌
  → Каждый раз сохраняет скриншот синей кнопки
  → Накопилось 50 негативных примеров
```

#### День 2 (после 100 попыток): Автоматическое переобучение
```
⚡ ТРИГГЕР: Накоплено 100 примеров!
🔄 Запуск автоматического переобучения...

============================================================
🧠 ПЕРЕОБУЧЕНИЕ: templates/tiktok-like.png
============================================================

📊 Примеры:
   ✅ Успешных: 50 (старые, красная кнопка)
   ❌ Неудачных: 50 (новые, синяя кнопка)

🔍 Анализ неудачных примеров...
   💡 Неудачи сконцентрированы в одной области
      Возможно, кнопка изменила внешний вид
      Центр: (450, 320)

🎨 Создание улучшенного шаблона...
   📸 Создание шаблона из 50 примеров...
   ✅ Шаблон сохранен: learning/models/tiktok-like_template.pkl
   🖼️  Визуализация: learning/models/tiktok-like_template.png

📈 Статистика после переобучения:
   Всего попыток: 100
   Точность: 50.0%

============================================================
```

#### День 3: Система научилась!
```
Попытка 101: Находит синюю кнопку 💙 ✅
Попытка 102-200: Находит ✅ ✅ ✅
Точность: 95%

🎉 Система адаптировалась к новому дизайну!
```

---

## 📁 Структура файлов

```
local-macros/
├── learning/
│   ├── __init__.py
│   ├── database.py              # База данных
│   ├── learning_system.py       # Система обучения
│   ├── memory.db                # SQLite база
│   ├── models/                  # Обученные модели
│   │   ├── tiktok-like_template.pkl
│   │   └── tiktok-like_template.png
│   └── plots/                   # Графики
│       ├── tiktok-like_accuracy.png
│       └── success_failure_distribution.png
│
├── utils/
│   ├── learning_stats.py        # Просмотр статистики
│   └── visualize_learning.py    # Визуализация
│
└── macro_sequence.py            # Интеграция
```

---

## 🔧 API

### ExecutionDatabase

```python
from learning import ExecutionDatabase

db = ExecutionDatabase("learning/memory.db")

# Запись выполнения
db.record_execution(
    template_id="templates/button.png",
    success=True,
    screenshot=img_array,
    region=(100, 200, 50, 50),
    method="template_match"
)

# Получение статистики
stats = db.get_statistics("templates/button.png")
print(f"Точность: {stats['accuracy']*100}%")

# Получение последнего успеха
last_success = db.get_last_success("templates/button.png")
if last_success:
    region = last_success['region']
    screenshot = last_success['screenshot']
```

### LearningSystem

```python
from learning import LearningSystem

learning = LearningSystem(
    db_path="learning/memory.db",
    retrain_threshold=100  # Переобучение каждые 100 примеров
)

# Запись успеха
learning.record_success(
    template_id="templates/button.png",
    screenshot=img_array,
    region=(100, 200, 50, 50)
)

# Запись неудачи
learning.record_failure(
    template_id="templates/button.png",
    screenshot=img_array,
    region=(100, 200, 50, 50),
    context="Button not found"
)

# Ручное переобучение
learning.retrain("templates/button.png")

# Статистика
learning.print_statistics()
```

---

## 📊 Преимущества

### Без Learning System:
```
❌ Дизайн изменился → Система сломалась
❌ Нужно вручную обновлять шаблоны
❌ Постоянная поддержка
❌ Не адаптируется
```

### С Learning System:
```
✅ Дизайн изменился → Система адаптируется
✅ Автоматическое улучшение
✅ Минимальная поддержка
✅ Становится точнее со временем
✅ Анализ ошибок
✅ Визуализация прогресса
```

---

## 🎯 Когда полезно?

### 1. Изменение дизайна
```
Сайт обновил интерфейс
→ Старые шаблоны не работают
→ Система переобучается
→ Снова работает
```

### 2. Разные условия
```
День: Светлая тема
Ночь: Тёмная тема
→ Система учится работать с обеими
```

### 3. Разные языки
```
Английский интерфейс
Русский интерфейс
→ Система адаптируется
```

### 4. A/B тестирование
```
Сайт показывает разные варианты
→ Система учится находить все варианты
```

---

## 🚀 Quick Start

### 1. Запусти макрос (обучение автоматическое)

```bash
python3 main.py → 2 → 11 → y
```

### 2. Посмотри статистику

```bash
python3 utils/learning_stats.py
```

### 3. Визуализируй прогресс

```bash
python3 utils/visualize_learning.py
```

---

## 💡 Советы

### Для лучшего обучения:

```
✅ Запускай макросы регулярно (больше данных)
✅ Не удаляй memory.db (история обучения)
✅ Проверяй статистику периодически
✅ Если точность падает → система переобучится автоматически
```

### Отключение обучения:

```python
# В macro_sequence.py
self.learning_enabled = False  # Отключить
```

---

**Система обучения работает! 🧠**

**Автоматическое улучшение! 🚀**

**Адаптация к изменениям! 🎯**

**Визуализация прогресса! 📊**
