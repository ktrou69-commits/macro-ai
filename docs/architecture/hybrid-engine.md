# üöÄ DOM-Vision Hybrid Engine - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ò–¥–µ—è:** –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å DOM (Selenium) –∏ Vision (Template Matching) –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

| –ú–µ—Ç–æ–¥ | –°–∫–æ—Ä–æ—Å—Ç—å | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | –¢–æ—á–Ω–æ—Å—Ç—å |
|-------|----------|------------|----------|
| **DOM** | ‚ö°‚ö°‚ö° –ë—ã—Å—Ç—Ä–æ | üü¢ –í—ã—Å–æ–∫–∞—è | üü¢ 100% |
| **Vision** | üêå –ú–µ–¥–ª–µ–Ω–Ω–æ | üü° –°—Ä–µ–¥–Ω—è—è | üü° 95% |
| **Hybrid** | ‚ö°‚ö° –°—Ä–µ–¥–Ω–µ | üü¢üü¢ –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | üü¢ 99% |

---

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         HYBRID ENGINE                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ   DOM    ‚îÇ         ‚îÇ  Vision  ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ Selenium ‚îÇ         ‚îÇ Template ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ          ‚îÇ         ‚îÇ Matching ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ       ‚îÇ                     ‚îÇ           ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îÇ                  ‚îÇ                      ‚îÇ
‚îÇ          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ          ‚îÇ  Auto Selector  ‚îÇ            ‚îÇ
‚îÇ          ‚îÇ  (Smart Logic)  ‚îÇ            ‚îÇ
‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ë–∞–∑–æ–≤—ã–π Hybrid Engine

**–§–∞–π–ª:** `utils/hybrid_engine.py`

```python
class HybridEngine:
    def __init__(self, vision_engine, dom_engine=None):
        self.vision = vision_engine
        self.dom = dom_engine
    
    def click(self, target, method='auto'):
        if method == 'auto':
            return self._auto_click(target)
        elif method == 'dom':
            return self._dom_click(target)
        elif method == 'vision':
            return self._vision_click(target)
```

---

### 2. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—ã–±–æ—Ä–∞

#### Auto (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):
```python
def _auto_click(self, target):
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ DOM —Å–µ–ª–µ–∫—Ç–æ—Ä
    if self._has_dom_selector(target):
        # 2. –ü—ã—Ç–∞–µ–º—Å—è DOM
        if self._dom_click(target):
            return True
        
        # 3. Fallback –Ω–∞ Vision
        return self._vision_click(target)
    
    # 4. –ò—Å–ø–æ–ª—å–∑—É–µ–º Vision
    return self._vision_click(target)
```

#### Hybrid (–û–±–∞ –º–µ—Ç–æ–¥–∞):
```python
def _hybrid_click(self, target):
    # 1. –ü—ã—Ç–∞–µ–º—Å—è DOM
    if self._dom_click(target):
        return True
    
    # 2. Fallback –Ω–∞ Vision
    return self._vision_click(target)
```

---

### 3. DOM –°–µ–ª–µ–∫—Ç–æ—Ä—ã

**–ú–∞–ø–ø–∏–Ω–≥ –∏–º–µ–Ω ‚Üí CSS —Å–µ–ª–µ–∫—Ç–æ—Ä—ã:**

```python
selectors = {
    # TikTok
    'Chrome-TikTok-Like': 'button[data-e2e="like-button"]',
    'Like': 'button[data-e2e="like-button"]',
    'Chrome-TikTok-Comment': 'button[data-e2e="comment-button"]',
    'Chrome-TikTok-Search': 'button[data-e2e="search-button"]',
    
    # YouTube
    'Chrome-YouTube-Like': 'button[aria-label*="like"]',
    'Chrome-YouTube-SearchField': 'input#search',
}
```

---

## üìã DSL –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å:

```atlas
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
click Chrome-TikTok-Like

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ DOM
click:dom Chrome-TikTok-Like

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ Vision
click:vision Chrome-TikTok-Like

# –ì–∏–±—Ä–∏–¥–Ω—ã–π (–ø—Ä–æ–±—É–µ—Ç –æ–±–∞)
click:hybrid Chrome-TikTok-Like
```

---

### –ü—Ä–∏–º–µ—Ä —Å Try/Catch:

```atlas
try:
    # –ü—ã—Ç–∞–µ–º—Å—è DOM (–±—ã—Å—Ç—Ä–æ)
    click:dom Chrome-TikTok-Like
    wait 1.5s
catch:
    # Fallback –Ω–∞ Vision (–Ω–∞–¥–µ–∂–Ω–æ)
    log "DOM failed, using Vision"
    click:vision Chrome-TikTok-Like
    wait 1.5s
end
```

---

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –õ–∞–π–∫ –≤ TikTok

```atlas
# Auto mode (—É–º–Ω—ã–π –≤—ã–±–æ—Ä)
click Chrome-TikTok-Like
wait 1.5s
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ DOM —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è Like
2. –ü—ã—Ç–∞–µ—Ç—Å—è DOM click (–±—ã—Å—Ç—Ä–æ)
3. –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Üí Vision click (–Ω–∞–¥–µ–∂–Ω–æ)

---

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–∏—Å–∫ –≤ TikTok

```atlas
# –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ - DOM –±—ã—Å—Ç—Ä–µ–µ
click:dom Chrome-TikTok-SearchField
wait 1s
type "#trending"
press enter
wait 3s
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚ö° –ë—ã—Å—Ç—Ä–µ–µ (DOM –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π)
- üéØ –¢–æ—á–Ω–µ–µ (100% –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç)

---

### –ü—Ä–∏–º–µ—Ä 3: Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

```atlas
try:
    # –ü—ã—Ç–∞–µ–º—Å—è DOM
    click:dom Chrome-TikTok-Like
catch:
    # Fallback –Ω–∞ Vision
    click:vision Chrome-TikTok-Like
end
```

---

### –ü—Ä–∏–º–µ—Ä 4: –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º

```atlas
# –ü—Ä–æ–±—É–µ—Ç –æ–±–∞ –º–µ—Ç–æ–¥–∞
click:hybrid Chrome-TikTok-Like
wait 1.5s
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—ã—Ç–∞–µ—Ç—Å—è DOM
2. –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Üí –ø—ã—Ç–∞–µ—Ç—Å—è Vision
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```python
hybrid.print_stats()

# –í—ã–≤–æ–¥:
================================================================================
HYBRID ENGINE STATISTICS
================================================================================

üåê DOM:
  Success: 45
  Fail:    5
  Total:   50
  Rate:    90.0%

üëÅÔ∏è  Vision:
  Success: 5
  Fail:    0
  Total:   5
  Rate:    100.0%

================================================================================
```

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å macro_sequence.py

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ _execute_step:

```python
def _execute_step(self, step: dict) -> bool:
    action = step.get('action')
    
    # CLICK —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–µ—Ç–æ–¥–∞
    if action == 'click':
        method = step.get('method', 'auto')  # auto, dom, vision, hybrid
        template = step.get('template')
        
        if self.hybrid_engine:
            return self.hybrid_engine.click(template, method=method)
        else:
            # Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π Vision
            return self._vision_click(template)
```

---

### –ü–∞—Ä—Å–∏–Ω–≥ DSL —Å –º–µ—Ç–æ–¥–æ–º:

```python
# atlas_dsl_parser.py

def _parse_line(self, line):
    # CLICK —Å –º–µ—Ç–æ–¥–æ–º: click:dom, click:vision, click:hybrid
    if line.startswith('click:'):
        parts = line.split()
        method_and_action = parts[0]  # "click:dom"
        method = method_and_action.split(':')[1]  # "dom"
        template_name = ' '.join(parts[1:])
        
        return {
            'action': 'click',
            'method': method,  # dom, vision, hybrid
            'template': self._resolve_template(template_name)
        }
```

---

## üéØ Roadmap –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤—ã–π Hybrid (1-2 –¥–Ω—è) ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å `hybrid_engine.py`
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å auto/dom/vision –º–µ—Ç–æ–¥—ã
- [x] –ë–∞–∑–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å macro_sequence.py
- [ ] –ü–∞—Ä—Å–∏–Ω–≥ DSL —Å –º–µ—Ç–æ–¥–∞–º–∏

### –§–∞–∑–∞ 2: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã (2-3 –¥–Ω—è)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
- [ ] DOM snapshot –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- [ ] Vision ‚Üí DOM resolver (bbox ‚Üí selector)
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤

### –§–∞–∑–∞ 3: –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ (3-5 –¥–Ω–µ–π)
- [ ] Machine learning –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤

### –§–∞–∑–∞ 4: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—á–∏ (1-2 –Ω–µ–¥–µ–ª–∏)
- [ ] CDP (Chrome DevTools Protocol)
- [ ] Network interception
- [ ] JavaScript injection
- [ ] Shadow DOM support

---

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å macro_sequence.py

```python
# –í __init__
self.hybrid_engine = None
if selenium_available:
    self.hybrid_engine = HybridEngine(self, self.driver)

# –í _execute_step
if self.hybrid_engine:
    return self.hybrid_engine.click(template, method=method)
```

---

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞

```python
# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ click:dom, click:vision, click:hybrid
if line.startswith('click:'):
    method = line.split(':')[1].split()[0]
    return {'action': 'click', 'method': method, ...}
```

---

### 3. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤

```python
# –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –º–∞–ø–ø–∏–Ω–≥–æ–≤
selectors = {
    # TikTok (–≤—Å–µ –∫–Ω–æ–ø–∫–∏)
    'Chrome-TikTok-Like': 'button[data-e2e="like-button"]',
    'Chrome-TikTok-Share': 'button[data-e2e="share-button"]',
    'Chrome-TikTok-Follow': 'button[data-e2e="follow-button"]',
    
    # YouTube (–≤—Å–µ –∫–Ω–æ–ø–∫–∏)
    'Chrome-YouTube-Like': 'button[aria-label*="like"]',
    'Chrome-YouTube-Dislike': 'button[aria-label*="Dislike"]',
    'Chrome-YouTube-Subscribe': 'button[aria-label*="Subscribe"]',
}
```

---

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç
python3 tests/test_hybrid_engine.py

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞–∫—Ä–æ—Å —Å hybrid
python3 main.py
# ‚Üí –í—ã–±—Ä–∞—Ç—å –º–∞–∫—Ä–æ—Å —Å click:dom
```

---

## üéâ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Hybrid

### 1. –°–∫–æ—Ä–æ—Å—Ç—å ‚ö°
```
DOM click:    ~50ms
Vision click: ~2000ms
Hybrid:       ~50-2000ms (–≤ —Å—Ä–µ–¥–Ω–µ–º ~500ms)
```

### 2. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å üõ°Ô∏è
```
DOM:    90% (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤)
Vision: 95% (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —à–∞–±–ª–æ–Ω–æ–≤)
Hybrid: 99% (fallback –Ω–∞ Vision)
```

### 3. –ì–∏–±–∫–æ—Å—Ç—å üîß
```
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞
- –†—É—á–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å —á–µ—Ä–µ–∑ DSL
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
```

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
‚úÖ utils/hybrid_engine.py              (Hybrid Engine)
‚úÖ docs/HYBRID_ENGINE_IMPLEMENTATION.md (–≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
```

---

## üöÄ –ü–æ–ø—Ä–æ–±—É–π!

```bash
# 1. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
from utils.hybrid_engine import HybridEngine

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
hybrid = HybridEngine(vision_engine, dom_engine)

# 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
hybrid.click("Chrome-TikTok-Like", method='auto')

# 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
hybrid.print_stats()
```

---

**Hybrid Engine —Å–æ–∑–¥–∞–Ω! ‚úÖ**

**–õ—É—á—à–µ–µ –∏–∑ –¥–≤—É—Ö –º–∏—Ä–æ–≤! üåêüëÅÔ∏è**

**–ì–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏! üöÄ**
