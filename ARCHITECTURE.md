# 🏗️ Архитектура Macro AI

## 📊 Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                      MACRO AI SYSTEM                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │         WORKFLOW PIPELINE                │
        └─────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   CAPTURE    │    │    BUILD     │    │     RUN      │
│   TEMPLATES  │───▶│  SEQUENCES   │───▶│   MACROS     │
└──────────────┘    └──────────────┘    └──────────────┘
```

---

## 🎯 Компоненты системы

### 1. CAPTURE - Захват шаблонов

```
┌────────────────────────────────────────────┐
│         smart_capture.py                   │
├────────────────────────────────────────────┤
│                                            │
│  Input:  Экран приложения                 │
│          ↓                                 │
│  Process: 1. Задержка (0-30 сек)         │
│           2. Интерактивное выделение      │
│           3. Превью (3x zoom)             │
│           4. Сохранение PNG               │
│          ↓                                 │
│  Output: models/*.png                     │
│                                            │
└────────────────────────────────────────────┘
```

**Создаваемые файлы:**
```
models/
├── like_button.png       # Кнопка лайка
├── comment_button.png    # Кнопка комментариев
├── share_button.png      # Кнопка шеринга
└── custom_button.png     # Любая кнопка
```

---

### 2. BUILD - Создание последовательностей

```
┌────────────────────────────────────────────┐
│        sequence_builder.py                 │
├────────────────────────────────────────────┤
│                                            │
│  Input:  Шаблоны (models/*.png)          │
│          ↓                                 │
│  Process: 1. Создание последовательности  │
│           2. Добавление шагов:            │
│              • Click (template)           │
│              • Wait (pause)               │
│              • Type (text)                │
│              • Key (keyboard)             │
│              • Hotkey (combo)             │
│              • Scroll (up/down)           │
│              • Record (coordinates)       │
│           3. Сохранение YAML              │
│          ↓                                 │
│  Output: *.yaml конфиг                    │
│                                            │
└────────────────────────────────────────────┘
```

**Альтернативный путь:**
```
┌────────────────────────────────────────────┐
│        record_actions.py                   │
├────────────────────────────────────────────┤
│                                            │
│  Input:  Действия пользователя            │
│          ↓                                 │
│  Process: 1. Запись кликов                │
│           2. Запись скролла               │
│           3. Запись клавиш                │
│           4. Запись текста                │
│           5. Автопаузы                    │
│          ↓                                 │
│  Output: *.yaml конфиг                    │
│                                            │
└────────────────────────────────────────────┘
```

**Создаваемые файлы:**
```
my_sequences.yaml
atlas_sequences.yaml
custom_workflow.yaml
```

---

### 3. RUN - Выполнение макросов

```
┌────────────────────────────────────────────┐
│        macro_sequence.py                   │
├────────────────────────────────────────────┤
│                                            │
│  Input:  YAML конфиг + Шаблоны            │
│          ↓                                 │
│  Process: ┌──────────────────────┐        │
│           │  Для каждого шага:   │        │
│           ├──────────────────────┤        │
│           │  1. CLICK:           │        │
│           │     • Захват экрана  │        │
│           │     • Template Match │        │
│           │     • Клик           │        │
│           │                      │        │
│           │  2. WAIT:            │        │
│           │     • time.sleep()   │        │
│           │                      │        │
│           │  3. TYPE:            │        │
│           │     • Detect cyrillic│        │
│           │     • Input text     │        │
│           │                      │        │
│           │  4. KEY:             │        │
│           │     • Press key      │        │
│           │                      │        │
│           │  5. HOTKEY:          │        │
│           │     • Key combo      │        │
│           │                      │        │
│           │  6. SCROLL:          │        │
│           │     • Scroll up/down │        │
│           └──────────────────────┘        │
│          ↓                                 │
│  Output: Выполненные действия             │
│          Статистика                       │
│                                            │
└────────────────────────────────────────────┘
```

---

## 🔍 Template Matching Pipeline

```
┌─────────────────────────────────────────────────────────┐
│              TEMPLATE MATCHING PROCESS                   │
└─────────────────────────────────────────────────────────┘

1. ЗАХВАТ ЭКРАНА
   ┌──────────────┐
   │ pyautogui    │
   │ .screenshot()│
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ NumPy array  │
   └──────┬───────┘
          │
          ▼
2. ЗАГРУЗКА ШАБЛОНА
   ┌──────────────┐
   │ cv2.imread() │
   │ template.png │
   └──────┬───────┘
          │
          ▼
3. ПОИСК СОВПАДЕНИЯ
   ┌──────────────────────┐
   │ cv2.matchTemplate()  │
   │ TM_CCOEFF_NORMED     │
   └──────┬───────────────┘
          │
          ▼
4. АНАЛИЗ РЕЗУЛЬТАТА
   ┌──────────────────────┐
   │ cv2.minMaxLoc()      │
   │ max_val, max_loc     │
   └──────┬───────────────┘
          │
          ▼
5. ПРОВЕРКА УВЕРЕННОСТИ
   ┌──────────────────────┐
   │ if max_val >= 0.8:   │
   │   ✅ Найдено!        │
   │ else:                │
   │   ❌ Не найдено      │
   └──────┬───────────────┘
          │
          ▼
6. КЛИК
   ┌──────────────────────┐
   │ pyautogui.click()    │
   │ (x, y)               │
   └──────────────────────┘
```

---

## ⌨️ Text Input Pipeline

```
┌─────────────────────────────────────────────────────────┐
│                TEXT INPUT PROCESS                        │
└─────────────────────────────────────────────────────────┘

1. ПОЛУЧЕНИЕ ТЕКСТА
   ┌──────────────┐
   │ text: str    │
   └──────┬───────┘
          │
          ▼
2. ОПРЕДЕЛЕНИЕ КИРИЛЛИЦЫ
   ┌───────────────────────────┐
   │ has_cyrillic = any(       │
   │   '\u0400' <= c <= '\u04FF'│
   │   for c in text            │
   │ )                          │
   └──────┬────────────────────┘
          │
          ├─── Да ──┐
          │         │
          │         ▼
          │    ┌─────────────────┐
          │    │ pyperclip.copy()│
          │    │ Cmd+V           │
          │    └─────────────────┘
          │
          └─── Нет ──┐
                     │
                     ▼
               ┌─────────────────┐
               │ pyautogui.write()│
               └─────────────────┘
```

---

## 🖱️ Scroll Pipeline

```
┌─────────────────────────────────────────────────────────┐
│                 SCROLL PROCESS                           │
└─────────────────────────────────────────────────────────┘

1. ПАРАМЕТРЫ
   ┌──────────────────┐
   │ direction: str   │ → "up" или "down"
   │ amount: int      │ → 1-20 (сила)
   │ clicks: int      │ → количество
   │ pause: float     │ → задержка
   └──────┬───────────┘
          │
          ▼
2. РАСЧЕТ НАПРАВЛЕНИЯ
   ┌───────────────────────────┐
   │ if direction == 'down':   │
   │   scroll_amount = amount  │
   │ else:                     │
   │   scroll_amount = -amount │
   └──────┬────────────────────┘
          │
          ▼
3. ВЫПОЛНЕНИЕ
   ┌───────────────────────────┐
   │ for i in range(clicks):   │
   │   pyautogui.scroll(amount)│
   │   time.sleep(pause)       │
   └───────────────────────────┘
```

---

## 🎬 Record Actions Pipeline

```
┌─────────────────────────────────────────────────────────┐
│            RECORD ACTIONS PROCESS                        │
└─────────────────────────────────────────────────────────┘

1. ИНИЦИАЛИЗАЦИЯ
   ┌──────────────────┐
   │ pynput.Listener  │
   │ • mouse          │
   │ • keyboard       │
   └──────┬───────────┘
          │
          ▼
2. ЗАПИСЬ СОБЫТИЙ
   ┌────────────────────────────┐
   │ Mouse Click:               │
   │   • Координаты (x, y)      │
   │   • Количество кликов      │
   │   • Время                  │
   │                            │
   │ Mouse Scroll:              │
   │   • Направление (dx, dy)   │
   │   • Сила (amount)          │
   │   • Время                  │
   │                            │
   │ Keyboard Key:              │
   │   • Клавиша (key)          │
   │   • Время                  │
   │                            │
   │ Keyboard Text:             │
   │   • Текст (char)           │
   │   • Время                  │
   └──────┬─────────────────────┘
          │
          ▼
3. ОБРАБОТКА
   ┌────────────────────────────┐
   │ • Группировка скроллов     │
   │ • Определение двойных      │
   │   кликов                   │
   │ • Автопаузы (>0.5 сек)     │
   │ • Объединение текста       │
   └──────┬─────────────────────┘
          │
          ▼
4. СОХРАНЕНИЕ
   ┌────────────────────────────┐
   │ YAML формат:               │
   │ - action: click            │
   │   position: absolute       │
   │   x: 500                   │
   │   y: 300                   │
   │                            │
   │ - action: scroll           │
   │   direction: down          │
   │   amount: 12               │
   │                            │
   │ - action: type             │
   │   text: "Hello"            │
   └────────────────────────────┘
```

---

## 🔄 Execution Flow

```
┌─────────────────────────────────────────────────────────┐
│              MACRO EXECUTION FLOW                        │
└─────────────────────────────────────────────────────────┘

START
  │
  ▼
┌─────────────────┐
│ Load Config     │ → Чтение YAML
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Parse Sequence  │ → Парсинг шагов
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Delay (optional)│ → Задержка перед стартом
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│ FOR EACH STEP:                  │
│                                 │
│  ┌─────────────────────────┐   │
│  │ 1. Log step info        │   │
│  └──────────┬──────────────┘   │
│             │                   │
│             ▼                   │
│  ┌─────────────────────────┐   │
│  │ 2. Execute action:      │   │
│  │    • click → template   │   │
│  │    • wait → sleep       │   │
│  │    • type → input       │   │
│  │    • key → press        │   │
│  │    • hotkey → combo     │   │
│  │    • scroll → scroll    │   │
│  └──────────┬──────────────┘   │
│             │                   │
│             ▼                   │
│  ┌─────────────────────────┐   │
│  │ 3. Check result         │   │
│  │    ✅ Success           │   │
│  │    ❌ Error             │   │
│  └──────────┬──────────────┘   │
│             │                   │
│             ▼                   │
│  ┌─────────────────────────┐   │
│  │ 4. Update stats         │   │
│  └─────────────────────────┘   │
│                                 │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────┐
│ Print Stats     │ → Статистика выполнения
└────────┬────────┘
         │
         ▼
       END
```

---

## 📊 Data Flow

```
┌─────────────────────────────────────────────────────────┐
│                    DATA FLOW                             │
└─────────────────────────────────────────────────────────┘

USER INPUT
    │
    ▼
┌─────────────────┐
│ smart_capture   │ → PNG файлы
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ models/         │ → Хранилище шаблонов
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│sequence_builder │ → YAML конфиг
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ *.yaml          │ → Хранилище последовательностей
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│macro_sequence   │ → Выполнение
└────────┬────────┘
         │
         ▼
    ACTIONS
```

---

## 🧩 Module Dependencies

```
┌─────────────────────────────────────────────────────────┐
│              MODULE DEPENDENCIES                         │
└─────────────────────────────────────────────────────────┘

macro_sequence.py
    ├── numpy
    ├── pillow (PIL)
    ├── opencv-python (cv2)
    ├── pyautogui
    ├── pyperclip
    └── pyyaml

sequence_builder.py
    ├── pyautogui
    ├── pynput
    └── pyyaml

record_actions.py
    ├── pyautogui
    ├── pynput
    └── pyyaml

smart_capture.py
    ├── pyautogui
    ├── pillow (PIL)
    └── opencv-python (cv2)

test_template.py
    ├── numpy
    ├── pillow (PIL)
    ├── opencv-python (cv2)
    └── pyautogui
```

---

## 🎯 System Architecture Summary

```
┌──────────────────────────────────────────────────────────┐
│                  MACRO AI ARCHITECTURE                    │
├──────────────────────────────────────────────────────────┤
│                                                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   CAPTURE   │  │    BUILD    │  │     RUN     │     │
│  │             │  │             │  │             │     │
│  │ Templates   │→ │ Sequences   │→ │  Macros     │     │
│  │             │  │             │  │             │     │
│  │ • Screenshot│  │ • Click     │  │ • Template  │     │
│  │ • Select    │  │ • Wait      │  │   Matching  │     │
│  │ • Save PNG  │  │ • Type      │  │ • Execute   │     │
│  │             │  │ • Key       │  │ • Stats     │     │
│  │             │  │ • Hotkey    │  │             │     │
│  │             │  │ • Scroll    │  │             │     │
│  │             │  │ • Record    │  │             │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                                                           │
│  ┌──────────────────────────────────────────────────┐   │
│  │              CORE TECHNOLOGIES                    │   │
│  ├──────────────────────────────────────────────────┤   │
│  │ • OpenCV (Template Matching)                     │   │
│  │ • PyAutoGUI (Mouse/Keyboard Control)             │   │
│  │ • PyPerclip (Clipboard for Cyrillic)             │   │
│  │ • Pynput (Action Recording)                      │   │
│  │ • PyYAML (Config Management)                     │   │
│  └──────────────────────────────────────────────────┘   │
│                                                           │
│  ┌──────────────────────────────────────────────────┐   │
│  │              FEATURES                             │   │
│  ├──────────────────────────────────────────────────┤   │
│  │ ✅ Position-independent button detection         │   │
│  │ ✅ Cyrillic text support                         │   │
│  │ ✅ Scroll automation                             │   │
│  │ ✅ Action recording                              │   │
│  │ ✅ Sequence builder                              │   │
│  │ ✅ Apple Silicon optimized                       │   │
│  └──────────────────────────────────────────────────┘   │
│                                                           │
└──────────────────────────────────────────────────────────┘
```

---

**Готово!** Полная архитектура Macro AI! 🏗️
